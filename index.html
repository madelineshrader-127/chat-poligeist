<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The PoliGeist – Politics, Culture, and the Supernatural</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CVkqkXNQ/ZH/XLlvWZOJyj7Yy7tcenmpD1ypASozpmT/E0iPtmFIB46ZmdtAc9eNBvH0H/ZpiBw==" crossorigin="anonymous" referrerpolicy="no-referrer">
  <script src="https://npmcdn.com/parse@3.4.4/dist/parse.min.js"></script>
  <style>
    /* Reset and base styles */
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: Georgia, 'Times New Roman', serif; line-height:1.8; color:#333; background:#f9f9f9; }

    /* Loading spinner */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .loading-overlay.active { display: flex; }
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #98A1BC;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Header */
    header {
      background: #555879;
      color: white;
      padding: 2.5rem 1rem;
      text-align: center;
      border-bottom: 4px solid #98A1BC;
    }
    h1 { font-size:clamp(2rem, 5vw, 3rem); font-weight:700; letter-spacing:2px; margin-bottom:0.5rem; }
    .subtitle { font-size:1.1rem; font-style:italic; opacity:0.9; }

    /* Nav */
    nav {
      background: #555879;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .nav-container {
      max-width: 1000px;
      margin: 0 auto;
      display: flex;
      justify-content: center;
      gap: 0;
      flex-wrap: wrap;
    }
    .nav-tab {
      flex: 1;
      min-width: 120px;
      padding: 1rem 1.5rem;
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      color: #ecf0f1;
      transition: all 0.3s;
      border-bottom: 3px solid transparent;
      font-family: Georgia, serif;
    }
    .nav-tab:hover, .nav-tab:focus {
      background: #6a6d8c;
      color: white;
      outline: 2px solid #98A1BC;
      outline-offset: -2px;
    }
    .nav-tab.active {
      background: #6a6d8c;
      border-bottom-color: #98A1BC;
    }

    /* Main container */
    .container { max-width:900px; margin:0 auto; padding:2rem 20px; }

    /* Tabs content */
    .tab-content { display:none; }
    .tab-content.active { display:block; }

    /* Admin panel toggle */
    .admin-toggle { text-align:center; margin:2rem 0; }
    .toggle-btn { 
      background:#95a5a6; 
      color:white; 
      border:none; 
      padding:0.75rem 1.5rem; 
      font-size:0.95rem; 
      border-radius:4px; 
      cursor:pointer; 
      transition:background 0.3s; 
      font-family:Georgia, serif; 
    }
    .toggle-btn:hover, .toggle-btn:focus { 
      background:#7f8c8d; 
      outline: 2px solid #555879;
      outline-offset: 2px;
    }
    .logout-btn {
      background: #e74c3c;
      margin-left: 1rem;
    }
    .logout-btn:hover, .logout-btn:focus {
      background: #c0392b;
    }

    /* Admin panel form */
    .admin-panel { 
      background:white; 
      margin:2rem 0; 
      padding:2rem; 
      border-radius:4px; 
      box-shadow:0 2px 8px rgba(0,0,0,0.1); 
      border-left:4px solid #98A1BC; 
    }
    .admin-panel h2 { font-size:1.8rem; margin-bottom:1.5rem; color:#2c3e50; }
    .form-group { margin-bottom:1.5rem; }
    label { display:block; font-weight:600; margin-bottom:0.5rem; color:#2c3e50; font-size:1rem; }
    input, select { 
      width:100%; 
      padding:0.75rem; 
      border:1px solid #bdc3c7; 
      border-radius:4px; 
      font-size:1rem; 
      font-family:Georgia, serif; 
      transition:border-color 0.3s; 
    }
    select { background:white; cursor:pointer; }
    input:focus, select:focus { outline:none; border-color:#98A1BC; box-shadow: 0 0 0 3px rgba(152,161,188,0.2); }

    /* Editor toolbar */
    #toolbar { margin-bottom: 0.5rem; }
    #toolbar button {
      background:#98A1BC; 
      color:white; 
      border:none; 
      padding:0.4rem 0.8rem; 
      margin-right:0.3rem; 
      margin-bottom: 0.3rem;
      border-radius:4px; 
      cursor:pointer; 
      font-family:Georgia, serif; 
      font-size:0.9rem;
    }
    #toolbar button:hover, #toolbar button:focus { 
      background:#7f879c; 
      outline: 2px solid #555879;
      outline-offset: 1px;
    }

    /* Editor */
    #content {
      min-height:200px;
      max-height: 400px;
      overflow-y: auto;
      border:1px solid #bdc3c7;
      border-radius:4px;
      padding:0.75rem;
      font-family:Georgia, serif;
      background: white;
    }
    #content:focus {
      outline: none;
      border-color: #98A1BC;
      box-shadow: 0 0 0 3px rgba(152,161,188,0.2);
    }

    /* Buttons */
    button[type="submit"], .subscribe-btn { 
      background:#98A1BC; 
      color:white; 
      border:none; 
      padding:0.75rem 2rem; 
      font-size:1rem; 
      border-radius:4px; 
      cursor:pointer; 
      transition:background 0.3s; 
      font-family:Georgia, serif; 
      font-weight:600; 
    }
    button[type="submit"]:hover, .subscribe-btn:hover,
    button[type="submit"]:focus, .subscribe-btn:focus { 
      background:#7f879c; 
      outline: 2px solid #555879;
      outline-offset: 2px;
    }
    button[type="submit"]:disabled, .subscribe-btn:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
    }
    .export-btn { background:#27ae60; margin-left:1rem; margin-top: 0.5rem; }
    .export-btn:hover, .export-btn:focus { background:#229954; }

    /* Posts */
    .post { 
      background:white; 
      padding:2.5rem; 
      margin-bottom:2rem; 
      border-radius:4px; 
      box-shadow:0 2px 8px rgba(0,0,0,0.1); 
      border-left:4px solid #98A1BC; 
      position: relative;
    }
    .post h2 { font-size:2rem; color:#2c3e50; margin-bottom:0.75rem; line-height:1.3; }
    .post-meta { color:#7f8c8d; font-size:0.95rem; margin-bottom:1.5rem; font-style:italic; }
    .post-content { color:#34495e; font-size:1.1rem; line-height:1.8; }
    .post-content img { max-width: 100%; height: auto; border-radius: 4px; margin: 1rem 0; }

    /* Delete button for posts */
    .delete-post-btn {
      position: absolute;
      top: 1rem;
      right: 1rem;
      background: #e74c3c;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.85rem;
      font-family: Georgia, serif;
      transition: background 0.3s;
    }
    .delete-post-btn:hover, .delete-post-btn:focus {
      background: #c0392b;
    }

    /* Empty states */
    .empty-state { 
      text-align:center; 
      padding:4rem 2rem; 
      color:#95a5a6; 
      background:white; 
      border-radius:4px; 
      box-shadow:0 2px 8px rgba(0,0,0,0.1); 
    }
    .empty-state h3 { font-size:1.8rem; margin-bottom:1rem; color:#7f8c8d; }
    .empty-state p { font-size:1.1rem; }

    /* Featured post */
    .featured-post { 
      background:white; 
      padding:3rem; 
      margin-bottom:2rem; 
      border-radius:4px; 
      box-shadow:0 4px 12px rgba(0,0,0,0.15); 
      border-left:6px solid #98A1BC; 
    }
    .featured-label { 
      display:inline-block; 
      background:#98A1BC; 
      color:white; 
      padding:0.4rem 1rem; 
      font-size:0.85rem; 
      font-weight:600; 
      text-transform:uppercase; 
      letter-spacing:1px; 
      margin-bottom:1rem; 
      border-radius:3px; 
    }
    .read-more-btn {
      background: #98A1BC;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-family: Georgia, serif;
      font-weight: 600;
      margin-top: 1.5rem;
      transition: background 0.3s;
    }
    .read-more-btn:hover, .read-more-btn:focus {
      background: #7f879c;
      outline: 2px solid #555879;
      outline-offset: 2px;
    }

    /* Subscribe box */
    #subscribe-box { 
      text-align:center; 
      margin:3rem 0; 
      padding: 2rem;
      background: white;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    #subscribe-box h3 {
      margin-bottom: 1rem;
      color: #2c3e50;
    }
    #subscribe-box input[type=email] { 
      max-width:300px; 
      margin-right:0.5rem; 
      margin-bottom: 0.5rem;
    }
    .thank-you { 
      color:#98A1BC; 
      font-weight:600; 
      margin-top:1rem; 
      display:none; 
    }

    /* Footer */
    footer {
      background:#555879;
      color:white;
      text-align:center;
      padding:1.5rem 0;
      margin-top:2rem;
    }
    footer a {
      color:white;
      text-decoration:none;
      margin:0 1rem;
      font-size:1.5rem;
      transition: color 0.3s;
    }
    footer a:hover, footer a:focus {
      color:#98A1BC;
      outline: 2px solid #98A1BC;
      outline-offset: 4px;
      border-radius: 4px;
    }

    /* Error message */
    .error-message {
      background: #e74c3c;
      color: white;
      padding: 1rem;
      border-radius: 4px;
      margin: 1rem 0;
      display: none;
    }
    .success-message {
      background: #27ae60;
      color: white;
      padding: 1rem;
      border-radius: 4px;
      margin: 1rem 0;
      display: none;
    }

    /* Config notice */
    .config-notice {
      background: #f39c12;
      color: white;
      padding: 1.5rem;
      border-radius: 4px;
      margin: 2rem 0;
      text-align: center;
    }
    .config-notice strong {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 1.2rem;
    }
    .setup-notice {
      background: #3498db;
      color: white;
      padding: 1.5rem;
      border-radius: 4px;
      margin: 2rem 0;
    }
    .setup-notice strong {
      display: block;
      margin-bottom: 0.5rem;
      font-size: 1.2rem;
    }
    .setup-notice ol {
      text-align: left;
      margin: 1rem 0 1rem 2rem;
    }
    .setup-notice li {
      margin-bottom: 0.5rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .nav-tab { padding: 0.75rem 1rem; font-size: 0.9rem; }
      .post, .featured-post { padding: 1.5rem; }
      h1 { font-size: 2rem; }
      #subscribe-box input[type=email] { max-width: 100%; margin-bottom: 1rem; }
      .export-btn { margin-left: 0; margin-top: 1rem; display: block; width: 100%; }
      .logout-btn { margin-left: 0; margin-top: 0.5rem; display: block; width: 100%; }
    }

    /* Character counter */
    .char-counter {
      font-size: 0.85rem;
      color: #7f8c8d;
      text-align: right;
      margin-top: 0.25rem;
    }
  </style>
</head>
<body>
<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
</div>

<header>
  <h1>The PoliGeist</h1>
  <p class="subtitle">Politics, Culture, and the Supernatural</p>
  <div id="jst-clock" style="margin-top:0.5rem; font-size:0.95rem; opacity:0.85;" aria-live="polite"></div>
</header>

<nav role="navigation" aria-label="Main navigation">
  <div class="nav-container">
    <button class="nav-tab active" onclick="switchTab('home', this)" aria-label="Home">Home</button>
    <button class="nav-tab" onclick="switchTab('about', this)" aria-label="About">About</button>
    <button class="nav-tab" onclick="switchTab('politics', this)" aria-label="Politics">Politics</button>
    <button class="nav-tab" onclick="switchTab('japanese', this)" aria-label="Japanese Supernatural Culture">Japanese Supernatural Culture</button>
  </div>
</nav>

<div class="container">
  <div id="configNotice" class="config-notice" style="display:none;">
    <strong>⚠️ Configuration Required</strong>
    <p>Please update the Back4app credentials in the code to connect to your database.</p>
  </div>

  <div id="setupNotice" class="setup-notice" style="display:none;">
    <strong>🔧 First Time Setup Required</strong>
    <p>Before you can use the admin panel, you need to create an admin user account:</p>
    <ol>
      <li>Go to your Back4app Dashboard → <strong>Database</strong></li>
      <li>Click on the <strong>_User</strong> class (it's auto-created by Back4app)</li>
      <li>Click <strong>+ Row</strong> to add a new user</li>
      <li>Fill in:
        <ul>
          <li><strong>username:</strong> admin (or any username you want)</li>
          <li><strong>password:</strong> your desired password (e.g., poligeist2024)</li>
        </ul>
      </li>
      <li>Click <strong>Create</strong></li>
      <li>Refresh this page and click "Admin Login"</li>
    </ol>
    <p><strong>Note:</strong> Back4app will automatically hash the password for security.</p>
  </div>

  <div class="error-message" id="errorMessage"></div>
  <div class="success-message" id="successMessage"></div>

  <div class="admin-toggle">
    <button class="toggle-btn" onclick="toggleAdmin()" aria-expanded="false" aria-controls="adminPanel">Admin Login</button>
    <button class="logout-btn" id="logoutBtn" onclick="logout()" style="display:none;">Logout</button>
  </div>

  <div class="admin-panel" id="adminPanel" style="display:none;" role="region" aria-label="Admin panel">
    <h2>Add New Post</h2>
    <form id="postForm">
      <div class="form-group">
        <label for="category">Category</label>
        <select id="category" required aria-required="true">
          <option value="about">About</option>
          <option value="politics">Politics</option>
          <option value="japanese">Japanese Supernatural Culture</option>
        </select>
      </div>
      <div class="form-group">
        <label for="title">Title</label>
        <input type="text" id="title" required aria-required="true" maxlength="200">
        <div class="char-counter" id="titleCounter">0 / 200</div>
      </div>
      <div class="form-group">
        <label for="content">Content</label>
        <div id="toolbar" role="toolbar" aria-label="Text formatting">
          <button type="button" onclick="format('bold')" aria-label="Bold" title="Bold"><b>B</b></button>
          <button type="button" onclick="format('italic')" aria-label="Italic" title="Italic"><i>I</i></button>
          <button type="button" onclick="format('underline')" aria-label="Underline" title="Underline"><u>U</u></button>
          <button type="button" onclick="format('insertUnorderedList')" aria-label="Bullet list" title="Bullet list">• List</button>
          <button type="button" onclick="format('insertOrderedList')" aria-label="Numbered list" title="Numbered list">1. List</button>
          <button type="button" onclick="insertImage()" aria-label="Insert image" title="Insert image">🖼️ Image</button>
        </div>
        <div id="content" contenteditable="true" role="textbox" aria-label="Post content" aria-multiline="true"></div>
      </div>
      <button type="submit" id="publishBtn">Publish Post</button>
      <button type="button" class="export-btn" onclick="exportPosts()">Export Data</button>
    </form>
  </div>

  <div id="homeTab" class="tab-content active" role="tabpanel" aria-label="Home">
    <div id="featuredPost">
      <div class="empty-state">
        <h3>Welcome to The PoliGeist</h3>
        <p>Loading articles...</p>
      </div>
    </div>
  </div>

  <div id="aboutTab" class="tab-content" role="tabpanel" aria-label="About">
    <div id="postsAbout" class="posts"></div>
  </div>

  <div id="politicsTab" class="tab-content" role="tabpanel" aria-label="Politics">
    <div id="postsPolitics" class="posts"></div>
  </div>

  <div id="japaneseTab" class="tab-content" role="tabpanel" aria-label="Japanese Supernatural Culture">
    <div id="postsJapanese" class="posts"></div>
  </div>

  <!-- Subscribe box -->
  <div id="subscribe-box">
    <h3>Subscribe to The PoliGeist</h3>
    <p>Get notified about new posts</p>
    <form onsubmit="subscribe(event)">
      <input type="email" id="subscriber-email" placeholder="Enter your email" required aria-required="true" aria-label="Email address">
      <button type="submit" class="subscribe-btn">Subscribe</button>
    </form>
    <div class="thank-you" id="thank-you-msg" role="status" aria-live="polite">Thank you for subscribing!</div>
  </div>
</div>

<footer role="contentinfo">
  <a href="https://www.linkedin.com/in/madeline-paul-shrader569514369?utm_source=share&utm_campaign=share_via&utm_content=profile&utm_medium=ios_app" target="_blank" rel="noopener noreferrer" aria-label="LinkedIn profile"><i class="fab fa-linkedin"></i></a>
  <a href="mailto:madeline.shrader@gmail.com" aria-label="Email contact"><i class="fas fa-envelope"></i></a>
</footer>

<script>
// ============================================
// BACK4APP CONFIGURATION
// ============================================
// TODO: Replace these with your Back4app credentials from:
// App Settings → Security & Keys
const BACK4APP_CONFIG = {
  applicationId: 'N42HIi3SmsBVL5GnM7GnaBxL4IDu0AvWy7l2IstG',
  javascriptKey: '64Hza26PALfid2HLCEKpbYgiVrS1kh3qCToPe8In',
  serverURL: 'https://parseapi.back4app.com'
};

// Initialize Parse
Parse.initialize(BACK4APP_CONFIG.applicationId, BACK4APP_CONFIG.javascriptKey);
Parse.serverURL = BACK4APP_CONFIG.serverURL;

// Check if config is set
const isConfigured = BACK4APP_CONFIG.applicationId !== 'YOUR_APPLICATION_ID_HERE';

// ============================================
// STATE MANAGEMENT
// ============================================
const STATE = {
  posts: [],
  subscribers: [],
  currentTab: 'home',
  currentUser: null
};

// ============================================
// LOADING SPINNER
// ============================================
function showLoading() {
  document.getElementById('loadingOverlay').classList.add('active');
}

function hideLoading() {
  document.getElementById('loadingOverlay').classList.remove('active');
}

// ============================================
// MESSAGE HANDLING
// ============================================
function showError(message) {
  const errorEl = document.getElementById('errorMessage');
  errorEl.textContent = message;
  errorEl.style.display = 'block';
  setTimeout(() => {
    errorEl.style.display = 'none';
  }, 5000);
}

function showSuccess(message) {
  const successEl = document.getElementById('successMessage');
  successEl.textContent = message;
  successEl.style.display = 'block';
  setTimeout(() => {
    successEl.style.display = 'none';
  }, 3000);
}

// ============================================
// JST CLOCK
// ============================================
function updateClock() {
  try {
    const now = new Date(new Date().toLocaleString("en-US", {timeZone:"Asia/Tokyo"}));
    const options = { 
      weekday:'long', 
      year:'numeric', 
      month:'long', 
      day:'numeric', 
      hour:'2-digit', 
      minute:'2-digit', 
      second:'2-digit',
      timeZone: 'Asia/Tokyo'
    };
    const clockEl = document.getElementById('jst-clock');
    if (clockEl) {
      clockEl.textContent = now.toLocaleDateString('en-US', options) + ' JST';
    }
  } catch (e) {
    console.error('Error updating clock:', e);
  }
}

// ============================================
// TABS
// ============================================
function switchTab(tab, button) {
  STATE.currentTab = tab;
  
  document.querySelectorAll('.nav-tab').forEach(btn => btn.classList.remove('active'));
  if (button) button.classList.add('active');
  
  document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
  const tabContent = document.getElementById(tab + 'Tab');
  if (tabContent) tabContent.classList.add('active');
}

// ============================================
// HTML UTILITIES
// ============================================
function escapeHTML(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}

// ============================================
// BACK4APP AUTHENTICATION
// ============================================
async function loginUser(username, password) {
  try {
    const user = await Parse.User.logIn(username, password);
    STATE.currentUser = user;
    return { success: true, user };
  } catch (error) {
    console.error('Login error:', error);
    
    // Check if it's a "user not found" error
    if (error.code === 101) {
      // Show setup instructions
      document.getElementById('setupNotice').style.display = 'block';
      return { success: false, error: 'No admin user found. Please create one in Back4app first (see instructions above).' };
    }
    
    return { success: false, error: error.message };
  }
}

function logoutUser() {
  Parse.User.logOut();
  STATE.currentUser = null;
}

// ============================================
// BACK4APP FUNCTIONS
// ============================================

// Load all posts from Back4app
async function loadPosts() {
  if (!isConfigured) {
    document.getElementById('configNotice').style.display = 'block';
    return;
  }

  showLoading();
  try {
    const Post = Parse.Object.extend('BlogPost');
    const query = new Parse.Query(Post);
    query.descending('createdAt');
    query.limit(1000);
    
    const results = await query.find();
    STATE.posts = results.map(post => ({
      id: post.id,
      category: post.get('category'),
      title: post.get('title'),
      content: post.get('content'),
      date: post.get('date'),
      timestamp: post.createdAt.getTime()
    }));
    
    renderPosts();
  } catch (error) {
    console.error('Error loading posts:', error);
    showError('Error loading posts: ' + error.message);
  } finally {
    hideLoading();
  }
}

// Save a new post to Back4app (requires authentication)
async function savePost(postData) {
  if (!isConfigured) {
    alert('Please configure Back4app credentials first.');
    return false;
  }

  if (!STATE.currentUser) {
    alert('You must be logged in to create posts.');
    return false;
  }

  showLoading();
  try {
    const Post = Parse.Object.extend('BlogPost');
    const post = new Post();
    
    // Set ACL so only the current user can edit/delete
    const acl = new Parse.ACL(STATE.currentUser);
    acl.setPublicReadAccess(true);
    post.setACL(acl);
    
    post.set('category', postData.category);
    post.set('title', postData.title);
    post.set('content', postData.content);
    post.set('date', postData.date);
    post.set('author', STATE.currentUser);
    
    await post.save();
    await loadPosts();
    return true;
  } catch (error) {
    console.error('Error saving post:', error);
    showError('Error saving post: ' + error.message);
    return false;
  } finally {
    hideLoading();
  }
}

// Delete a post from Back4app (requires authentication)
async function deletePost(postId) {
  if (!confirm('Are you sure you want to delete this post?')) {
    return;
  }

  if (!STATE.currentUser) {
    alert('You must be logged in to delete posts.');
    return;
  }

  showLoading();
  try {
    const Post = Parse.Object.extend('BlogPost');
    const query = new Parse.Query(Post);
    const post = await query.get(postId);
    await post.destroy();
    await loadPosts();
    showSuccess('Post deleted successfully!');
  } catch (error) {
    console.error('Error deleting post:', error);
    showError('Error deleting post: ' + error.message);
  } finally {
    hideLoading();
  }
}

// Save subscriber to Back4app
async function saveSubscriber(email) {
  if (!isConfigured) {
    return false;
  }

  try {
    const Subscriber = Parse.Object.extend('Subscriber');
    const query = new Parse.Query(Subscriber);
    query.equalTo('email', email);
    const existing = await query.first();
    
    if (existing) {
      return true; // Already subscribed
    }
    
    const subscriber = new Subscriber();
    subscriber.set('email', email);
    
    // Set public write access for subscribers
    const acl = new Parse.ACL();
    acl.setPublicReadAccess(false);
    acl.setPublicWriteAccess(true);
    subscriber.setACL(acl);
    
    await subscriber.save();
    return true;
  } catch (error) {
    console.error('Error saving subscriber:', error);
    showError('Error subscribing: ' + error.message);
    return false;
  }
}

// ============================================
// RENDER FUNCTIONS
// ============================================
function renderPosts() {
  renderFeaturedPost();
  renderCategoryPosts();
}

function renderFeaturedPost() {
  const featuredContainer = document.getElementById('featuredPost');
  if (!featuredContainer) return;
  
  if (STATE.posts.length === 0) {
    featuredContainer.innerHTML = `
      <div class="empty-state">
        <h3>Welcome to The PoliGeist</h3>
        <p>No articles published yet. ${STATE.currentUser ? 'Create your first post using the admin panel above!' : 'Check back soon for new content!'}</p>
      </div>`;
  } else {
    const latest = STATE.posts[0];
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = latest.content;
    const textContent = tempDiv.textContent || tempDiv.innerText || '';
    const preview = textContent.substring(0, 400) + (textContent.length > 400 ? '...' : '');
    
    featuredContainer.innerHTML = `
      <article class="featured-post">
        <span class="featured-label">Latest Article</span>
        <h2>${escapeHTML(latest.title)}</h2>
        <div class="post-meta">${escapeHTML(latest.date)}</div>
        <div class="post-content">${escapeHTML(preview)}</div>
        <button class="read-more-btn" onclick="goToFullArticle('${latest.category}')">Read More →</button>
      </article>`;
  }
}

function renderCategoryPosts() {
  const containers = {
    about: 'postsAbout',
    politics: 'postsPolitics',
    japanese: 'postsJapanese'
  };
  
  Object.keys(containers).forEach(category => {
    const container = document.getElementById(containers[category]);
    if (!container) return;
    
    const catPosts = STATE.posts.filter(p => p.category === category);
    
    if (catPosts.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <h3>No posts yet</h3>
          <p>${STATE.currentUser ? 'Create your first post in this category!' : 'Check back soon for new content!'}</p>
        </div>`;
    } else {
      container.innerHTML = catPosts.map(post => `
        <article class="post">
          ${STATE.currentUser ? `<button class="delete-post-btn" onclick="deletePost('${post.id}')">Delete</button>` : ''}
          <h2>${escapeHTML(post.title)}</h2>
          <div class="post-meta">${escapeHTML(post.date)}</div>
          <div class="post-content">${post.content}</div>
        </article>`).join('');
    }
  });
}

// Navigate to full article in appropriate tab
function goToFullArticle(category) {
  const tabButton = document.querySelector(`.nav-tab[onclick*="${category}"]`);
  if (tabButton) {
    switchTab(category, tabButton);
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }
}

// ============================================
// POST FORM
// ============================================
function initializeForm() {
  const form = document.getElementById('postForm');
  if (!form) return;
  
  form.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const category = document.getElementById('category').value;
    const title = document.getElementById('title').value.trim();
    const contentEl = document.getElementById('content');
    const content = contentEl.innerHTML.trim();
    
    if (!title || !content) {
      alert('Please fill in both title and content.');
      return;
    }
    
    const postData = {
      category,
      title,
      content,
      date: new Date().toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      })
    };
    
    const publishBtn = document.getElementById('publishBtn');
    publishBtn.disabled = true;
    publishBtn.textContent = 'Publishing...';
    
    const success = await savePost(postData);
    
    if (success) {
      document.getElementById('category').value = 'about';
      document.getElementById('title').value = '';
      contentEl.innerHTML = '';
      updateTitleCounter();
      showSuccess('Post published successfully!');
    }
    
    publishBtn.disabled = false;
    publishBtn.textContent = 'Publish Post';
  });
  
  const titleInput = document.getElementById('title');
  if (titleInput) {
    titleInput.addEventListener('input', updateTitleCounter);
  }
}

function updateTitleCounter() {
  const titleInput = document.getElementById('title');
  const counter = document.getElementById('titleCounter');
  if (titleInput && counter) {
    const length = titleInput.value.length;
    counter.textContent = `${length} / 200`;
  }
}

// ============================================
// ADMIN AUTHENTICATION
// ============================================
async function toggleAdmin() {
  const panel = document.getElementById('adminPanel');
  const button = document.querySelector('.toggle-btn');
  const logoutBtn = document.getElementById('logoutBtn');
  
  if (!panel || !button) return;
  
  const isHidden = panel.style.display === 'none';
  
  if (isHidden) {
    if (!STATE.currentUser) {
      // Prompt for username and password
      const username = prompt('Enter admin username:');
      if (!username) return;
      
      const password = prompt('Enter admin password:');
      if (!password) return;
      
      showLoading();
      const result = await loginUser(username, password);
      hideLoading();
      
      if (result.success) {
        panel.style.display = 'block';
        button.setAttribute('aria-expanded', 'true');
        button.textContent = 'Hide Admin Panel';
        logoutBtn.style.display = 'inline-block';
        renderPosts(); // Re-render to show delete buttons
        showSuccess('Logged in successfully!');
      } else {
        showError(result.error);
      }
    } else {
      panel.style.display = 'block';
      button.setAttribute('aria-expanded', 'true');
      button.textContent = 'Hide Admin Panel';
    }
  } else {
    panel.style.display = 'none';
    button.setAttribute('aria-expanded', 'false');
    button.textContent = 'Admin Login';
  }
}

function logout() {
  logoutUser();
  const panel = document.getElementById('adminPanel');
  const button = document.querySelector('.toggle-btn');
  const logoutBtn = document.getElementById('logoutBtn');
  
  panel.style.display = 'none';
  button.setAttribute('aria-expanded', 'false');
  button.textContent = 'Admin Login';
  logoutBtn.style.display = 'none';
  
  renderPosts(); // Re-render to hide delete buttons
  showSuccess('Logged out successfully!');
}

// ============================================
// EXPORT POSTS
// ============================================
function exportPosts() {
  try {
    const dataStr = JSON.stringify(STATE.posts, null, 2);
    const blob = new Blob([dataStr], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `poligeist-posts-${Date.now()}.json`;
    link.click();
    URL.revokeObjectURL(url);
  } catch (e) {
    console.error('Error exporting posts:', e);
    alert('Error exporting posts.');
  }
}

// ============================================
// TOOLBAR FUNCTIONS
// ============================================
function format(command) {
  try {
    document.execCommand(command, false, null);
    document.getElementById('content').focus();
  } catch (e) {
    console.error('Error formatting text:', e);
  }
}

function insertImage() {
  const url = prompt("Enter image URL (must be hosted online):");
  if (url && url.trim()) {
    try {
      new URL(url);
      document.execCommand('insertImage', false, url.trim());
      document.getElementById('content').focus();
    } catch (e) {
      alert('Please enter a valid URL.');
    }
  }
}

// ============================================
// SUBSCRIPTION
// ============================================
async function subscribe(event) {
  if (event) event.preventDefault();
  
  const emailInput = document.getElementById('subscriber-email');
  const email = emailInput.value.trim();
  
  if (!email) return;
  
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(email)) {
    alert('Please enter a valid email address.');
    return;
  }
  
  const subscribeBtn = event.target.querySelector('.subscribe-btn');
  subscribeBtn.disabled = true;
  subscribeBtn.textContent = 'Subscribing...';
  
  const success = await saveSubscriber(email);
  
  if (success) {
    const thankYouMsg = document.getElementById('thank-you-msg');
    if (thankYouMsg) {
      thankYouMsg.style.display = 'block';
      setTimeout(() => {
        thankYouMsg.style.display = 'none';
      }, 5000);
    }
    emailInput.value = '';
  }
  
  subscribeBtn.disabled = false;
  subscribeBtn.textContent = 'Subscribe';
}

// ============================================
// INITIALIZATION
// ============================================
document.addEventListener('DOMContentLoaded', function() {
  initializeForm();
  loadPosts();
  updateClock();
  setInterval(updateClock, 1000);
});
</script>
</body>
</html>
